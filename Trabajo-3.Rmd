---
title: "Codigos"
author: "Jennifer Salazar"
date: "26/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Librerias

```{r}
library(pdR)
library(forecast)
library(lmtest)
library(fANCOVA)
library(TSA)
library(uroot)
```


1. Análisis descriptivo y test HEGY de raıces unitarias estacionales, usando los primeros n = 216 datos de la serie.

Lectura de Datos 

```{r}
# Lectura de los datos
datos=read.table("anex-EMMET-dic2019-Fabricacion de otros productos quimicos (1).csv",header=T,sep=";",skip=14,dec=",",colClasses=c(rep("NULL",4),"numeric",rep("NULL",6)))
datos=ts(datos,freq=12,start=c(2001,1))


#Defina longitud serie recortada
n=length(datos)-12 #En este ejemplo se recortan 12 datos
t=1:n

#Serie recortada
yt=ts(datos[t],freq=12,start=c(2001,1))

# Para el pronostico
tnuevo=(n+1):length(datos)
ytf=ts(datos[tnuevo],freq=12,start=c(2019,1)) #Datos para la validación cruzada
```


a) Describa brevemente los patrones de la serie: tendencia, estacionalidad, presencia de ciclos y la varianza; explique
por que se puede o no considerar la tendencia y la estacionalidad como de tipo global.

Gráfica de la serie recortada

```{r}
plot(yt, lwd=2, xlab="Tiempo", ylab = "Producción nominal", col = '#717D7E')
grid()
```

(Decir todo lo que vemos a partir de la serie)

Como aplicar en R diferencias regulares y estacionales a una serie de tiempo

```{r}
Yt <- yt
difd1 <- diff(Yt)
difD12 <- diff(Yt,lag=12)
difdD12 <- diff(diff(Yt,lag=12))
```


b) Si la serie es de varianza constante, presente y analice las siguientes graficas

* de la serie recortada y su ACF muestral,

```{r}
par(mfrow=c(1,2))
plot(Yt, lwd=2, xlab="Tiempo", ylab = "Producción nominal", col = 'cyan4', main = "Serie original", cex.main=0.7)
grid()

acf(as.numeric(Yt),ci.type="ma",lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF serie original",cex.main=0.5)
```



* de su primera diferencia regular ∇Yt y su ACF muestral

```{r}
par(mfrow=c(1,2))
plot(difd1, lwd=2, xlab="Tiempo", ylab = "Producción nominal", col = 'cyan4', main="Serie primera diferencia regular", cex.main=0.7)
grid()

acf(as.numeric(difd1),ci.type="ma",lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF primera diferencia regular",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)
```


* de su primera diferencia estacional ∇12Yt y su ACF muestral

```{r}
par(mfrow=c(1,2))
plot(difD12, lwd=2, xlab="Tiempo", ylab = "Producción nominal", col = 'cyan4', cex.main=0.7, main="Serie primera diferencia estacional")
grid()

acf(as.numeric(difD12),ci.type="ma",lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF primera diferencia estacional",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)
```


* de la serie diferenciada por tendencia y estacionalidad (o sea ∇∇12Yt) y su ACF muestral

```{r}
par(mfrow=c(1,2))
plot(difdD12, lwd=2, xlab="Tiempo", ylab = "Producción nominal", col = 'cyan4', cex.main=0.7, main="Serie diferencia regular y estacional (d=D=1)")
grid()

acf(as.numeric(difdD12),ci.type="ma",lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF diferencia regular y estacional (d=D=1)",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)
```



Ejecución del test HEGY

```{r}
#Test Hegy sobre serie recortada
library(pdR)
HEGY.test(wts=yt,itsd=c(0,0,c(0)),selectlags=list(mode="aic", Pmax=12))$stats
```


**ACF de la serie y de las diferencias regular y estacionales:**

Lo siguiente no se utiliza solo es una ejemplificación de la profesora


```{r}
acf(as.numeric(Yt),ci.type="ma",lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF Yt",cex.main=0.5)

acf(as.numeric(difd1),ci.type="ma",lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF diferencia regular",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)

pacf(as.numeric(difd1),lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="PACF diferencia regular",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)

acf(as.numeric(difdD12),ci.type="ma",lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF diferencia regular y estacional (d=D=1)",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)


pacf(as.numeric(difdD12),lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF diferencia regular y estacional (d=D=1)",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)
```




**Como ajustar y pronosticar un SARIMA(p,d,q) × (P,D,Q)[s] sin deriva y con todos los coeficientes**

Ajuste y pronostico del modelo 1 ARIMA(8,1,2)(0,1,1)[12]

Ecuación:

$$\phi_8(B)  ∇^1_{12}
∇^dYt = \theta_2(B) \Theta_1(B^{12})Et$$

$$(1-\phi_1B-\phi_2B^2-\phi_3B^3-\phi_4B^4-\phi_5B^5-\phi_6B^6-\phi_7B^7-\phi_8B^8)(1-B)(1-B^{12})Y_t=(1+\theta_1+\theta_2B^2)(1+\Theta_1B^{12})E_t, ~con~ \{E_t\}_t~un~R.B \sim N(0, \sigma^2)$$

```{r}
modelo1=Arima(yt,order=c(8,1,2),seasonal=list(order=c(0,1,1)),method="ML")
coeftest(modelo1) 

pronostico1=ts(as.data.frame(forecast(modelo1,h=12,level=95)),freq=12,start=c(2019,1))
pronostico1

accuracy(pronostico1[,1],ytf)
```

#######################################################################


Ajuste y pronostico del modelo 2 ARIMA(1,0,2)(0,1,1)[12] con deriva:

Ecuación:

$$\phi_1(B)  ∇^1_{12}Yt = \delta + \theta_2(B) \Theta_1(B^{12})Et$$

$$(1-\phi_1B)(1-B^{12})Y_t=\delta+ (1+\theta_1+\theta_2B^2)(1+\Theta_1B^{12})E_t, ~con~ \{E_t\}_t~un~R.B \sim N(0, \sigma^2)$$



```{r}
modelo2=Arima(yt,order=c(1,0,2),seasonal=list(order=c(0,1,1)),method="ML", include.drift = T)
coeftest(modelo2) 

pronostico2=ts(as.data.frame(forecast(modelo2,h=12,level=95)),freq=12,start=c(2019,1))
pronostico2

accuracy(pronostico2[,1],ytf)
```




**identificación con armasubsets().**

Modelo 3

```{r}
plot(armasubsets(difdD12,nar=12,nma=12,y.name='AR',ar.method='ols'))
```

Parametros sombreados:

$$\phi_1, \phi_2, \phi_6, \phi_7, \theta_4, \Theta_1$$

* Polinomio AR regular: $\phi_7(B)=1-\phi_1B-\phi_2B^2-\phi_6B^6-\phi_7B^7$
* Polinomio MA regular: $\theta_4(B)=1+\theta_4B^4$
* Polinomio AR estacional: No hay
* Polinomio MA estacional: $\Theta_1(B^{12})=1+\Theta_1B^{12}$

Por lo tanto el modelo es un: $SARIMA(7,1,4)(0,1,1)[12]$


$$(1-\phi_1B-\phi_2B^2-\phi_6B^6-\phi_7B^7)(1-B)(1-B^{12})Y_t=(1+\theta_4B^4)(1+\Theta_1B^{12})E_t, ~con~ \{E_t\}_t~un~R.B \sim N(0, \sigma^2)$$

Ajuste y pronostico del modelo 3 

Por ejemplo, para ajustar sin deriva y pronosticar un SARIMA(7,1,4)×(0,1,1)[12], con $\phi_j \neq 0$, para j = 1, 2, 6, 7, $\theta_i \neq 0$, para
i = 4, y $\Theta_l \neq 0$ para l = 1, y asumiendo que Yt ya tiene formato de serie de tiempo con frecuencia s = 12:

```{r}
modelo3 <- Arima(yt,order=c(7,1,4),seasonal=list(order=c(0,1,1)),
fixed=c(NA,NA,0,0,0,NA, NA,rep(0,3),NA,NA),method="ML")

coeftest(modelo3)
pronostico3=ts(as.data.frame(forecast(modelo3,h=12,level=95)),freq=12,start=c(2019,1))
pronostico3

accuracy(pronostico3[,1],ytf)
```




Modelo 4


```{r}
plot(armasubsets(difdD12,nar=18,nma=18,y.name='AR',ar.method="ols"))
```

Parametros sombreados

$$\phi_1, \phi_2, \phi_8, \theta_4, \Theta_1, \theta_6 \Theta_1$$

Ademas se incluye el $\theta_6$

* Polinomio AR regular: $\phi_8(B)=1-\phi_1B-\phi_2B^2-\phi_8B^8$
* Polinomio MA regular: $\theta_6(B)=1+\theta_4B^4+\theta_6B^6$
* Polinomio AR estacional: No hay
* Polinomio MA estacional: $\Theta_1(B^{12})=1+\Theta_1B^{12}$

Por lo tanto el modelo es un: $SARIMA(8,1,6)(0,1,1)[12]$


$$(1-\phi_1B-\phi_2B^2-\phi_8B^8)(1-B)(1-B^{12})Y_t=(1+\theta_4B^4+\theta_6B^6)(1+\Theta_1B^{12})E_t, ~con~ \{E_t\}_t~un~R.B \sim N(0, \sigma^2)$$

Ajuste y pronostico del modelo 4 

Por ejemplo, para ajustar sin deriva y pronosticar un SARIMA(8,1,6)×(0,1,1)[12], con $\phi_j \neq 0$, para j = 1, 2, 8, $\theta_i \neq 0$, para
i = 4, 6 y $\Theta_l \neq 0$ para l = 1, y asumiendo que Yt ya tiene formato de serie de tiempo con frecuencia s = 12:



```{r}
modelo4 <- Arima(yt,order=c(8,1,6),seasonal=list(order=c(0,1,1)),
fixed=c(NA,NA,rep(0,5),NA, rep(0,3), NA, 0, NA, NA),method="ML")

coeftest(modelo4)
pronostico4=ts(as.data.frame(forecast(modelo4,h=12,level=95)),freq=12,start=c(2019,1))
pronostico4

accuracy(pronostico4[,1],ytf)
```

# Gráficas de ajuste de los modelos:


```{r}
#Ajustes

yhatmodelo1 <- modelo1$fitted
yhatmodelo2 <- modelo2$fitted
yhatmodelo3 <- modelo3$fitted
yhatmodelo4 <- modelo4$fitted

```



```{r}
# Modelo 1 
plot(yt,main="Ajuste con modelo 1")
lines(yhatmodelo1,col=4)
legend("topleft",legend=c("Real","ajustada"),col=c(1,4),lwd=2)
grid()

# Modelo 2
plot(yt,main="Ajuste con modelo 2")
lines(yhatmodelo2,col=2)
legend("topleft",legend=c("Real","ajustada"),col=c(1,2),lwd=2)
grid()

# Modelo 3
plot(yt,main="Ajuste con modelo 3")
lines(yhatmodelo3,col=3)
legend("topleft",legend=c("Real","ajustada"),col=c(1,3),lwd=2)
grid()

# Modelo 4
plot(yt,main="Ajuste con modelo 4")
lines(yhatmodelo4,col=3)
legend("topleft",legend=c("Real","ajustada"),col=c(1,3),lwd=2)
grid()
```



Punto 2 a)


```{r}
acf(as.numeric(difdD12),ci.type="ma",lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF diferencia regular y estacional (d=D=1)",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)


pacf(as.numeric(difdD12),lag.max=36,lwd=2,main="",cex.lab=0.5,cex.axis=0.5)
title(main="ACF diferencia regular y estacional (d=D=1)",cex.main=0.5)
abline(v=c(12,24,36),lty=2,col=2)
```


Punto 2 b)


```{r}
auto.arima(yt,ic="aic",seasonal.test="ocsb")
auto.arima(yt,ic="aic",seasonal.test="ch")
auto.arima(yt,ic="aic",seasonal.test="seas")
auto.arima(yt,ic="bic",seasonal.test="ocsb")
auto.arima(yt,ic="bic",seasonal.test="ch")
auto.arima(yt,ic="bic",seasonal.test="seas")
```



**Calculo de exp(C∗n(p)) en modelos ARIMA(p,d,q)(P,D,Q)[s]:**


```{r}
#Creando funci´on usuario crit.inf.resid() para calcular C*n(p)
crit.inf.resid=function(residuales,n.par,AIC="TRUE"){
  if(AIC=="TRUE"){
    #Calcula AIC
    CI=log(mean(residuales^2))+2*n.par/length(residuales)
  }
  if(AIC=="FALSE"){
    #Calcula BIC
    CI=log(mean(residuales^2))+n.par*log(length(residuales))/length(residuales)
  }
  CI
}


#Tome k igual al total de parametros del modelo, contando incluso la deriva cuando el modelo tenga este parametro
#Si no transformo a Yt:

k1 <- length(coef(modelo1)[coef(modelo1)!=0])
AICmodelo1=exp(crit.inf.resid(residuales=residuals(modelo1),n.par=k1))
BICmodelo1=exp(crit.inf.resid(residuales=residuals(modelo1),n.par=k1,AIC="FALSE"))


k2 <- length(coef(modelo2)[coef(modelo2)!=0])
AICmodelo2=exp(crit.inf.resid(residuales=residuals(modelo2),n.par=k2))
BICmodelo2=exp(crit.inf.resid(residuales=residuals(modelo2),n.par=k2,AIC="FALSE"))


k3 <- length(coef(modelo3)[coef(modelo3)!=0])
AICmodelo3=exp(crit.inf.resid(residuales=residuals(modelo3),n.par=k3))
BICmodelo3=exp(crit.inf.resid(residuales=residuals(modelo3),n.par=k3,AIC="FALSE"))


k4 <- length(coef(modelo4)[coef(modelo4)!=0])
AICmodelo4=exp(crit.inf.resid(residuales=residuals(modelo4),n.par=k4))
BICmodelo4=exp(crit.inf.resid(residuales=residuals(modelo4),n.par=k4,AIC="FALSE"))

```

(Poner los AIC y BIC en forma de tabla)



